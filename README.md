# NAct
A multithreaded actor system for node.js. 

<!-- Badges -->
[![Travis branch](https://img.shields.io/travis/ncthbrt/nact/master.svg?style=flat-square)]()
[![Coveralls](https://img.shields.io/coveralls/ncthbrt/nact.svg?style=flat-square)]() [![Dependencies](https://david-dm.org/ncthbrt/nact.svg?branch=master&style=flat-square)](https://david-dm.org/ncthbrt/nact) 

[![npm](https://img.shields.io/npm/v/nact.svg?style=flat-square)](https://www.npmjs.com/package/nact) [![js-semistandard-style](https://img.shields.io/badge/code%20style-semistandard-blue.svg?style=flat-square)](https://github.com/Flet/semistandard) 



## Sponsored by 

<a target="_blank" href="https://root.co.za">
  <svg width="109px" height="31px" viewBox="0 0 109 31" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <!-- Generator: Sketch 42 (36781) - http://www.bohemiancoding.com/sketch -->
      <title>Logo</title>
      <desc>Created with Sketch.</desc>
      <defs/>
      <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
          <g id="Artboard" transform="translate(-100.000000, -17.000000)" fill="#4E80D7">
              <g id="Logo" transform="translate(100.000000, 17.000000)">
                  <g id="Logo_Type" transform="translate(51.858954, 6.741690)">
                      <path d="M8.98519679,4.30892972 C8.57533035,4.05700962 8.17638329,3.89516778 7.79615514,3.8256468 C6.34504856,3.55391696 5.17823563,3.8065846 4.27426759,4.36163111 C3.94668642,4.56234489 3.65030346,4.80155685 3.39057839,5.07926699 L3.39057839,4.4584372 C3.39057839,4.22707438 3.19792946,4.03794742 2.96433289,4.03794742 L0.528142927,4.03794742 C0.292206489,4.03794742 0.101117473,4.22707438 0.101117473,4.4584372 L0.101117473,17.0873337 C0.101117473,17.3201916 0.292206489,17.5093186 0.528142927,17.5093186 L3.0789863,17.5093186 C3.31453276,17.5093186 3.50562177,17.3201916 3.50562177,17.0873337 L3.50562177,10.4880737 C3.50562177,9.97115162 3.56528834,9.47553433 3.68150166,9.00944477 C3.79420519,8.56054858 3.97047505,8.15538332 4.20251171,7.81002105 C4.42869871,7.47437676 4.70519282,7.2172239 5.04564325,7.02398549 C5.73356371,6.63489228 6.68510901,6.63489228 7.77353644,7.11967027 C7.88078028,7.16639136 8.00245328,7.16900774 8.11164701,7.12751942 C8.2196708,7.08154587 8.30507589,6.9952053 8.34680349,6.88718615 L9.15951677,4.81912398 C9.23517242,4.62812818 9.15951677,4.41470626 8.98519679,4.30892972" id="Fill-1"/>
                      <path d="M18.6759837,6.53550719 C19.8404568,6.53550719 20.7530043,6.89694151 21.4690032,7.63476091 C22.1795423,8.36996392 22.5398816,9.42660801 22.5398816,10.7740441 C22.5398816,11.4288869 22.4408273,12.0224316 22.2466185,12.5423438 C22.0547495,13.0577708 21.785275,13.5021818 21.4491143,13.8651112 C21.1110038,14.2272931 20.707377,14.5094884 20.2448636,14.710576 C19.3112572,15.1105085 18.0383704,15.1090134 17.088775,14.7090809 C16.6172921,14.5083671 16.2074256,14.225798 15.8732149,13.8666063 C15.5370542,13.505172 15.2749892,13.060761 15.0924797,12.5472028 C14.9072404,12.0291594 14.8120858,11.4311295 14.8120858,10.7740441 C14.8120858,10.1319095 14.9072404,9.53911239 15.0936497,9.00873461 C15.2749892,8.48919613 15.5378341,8.04142124 15.8732149,7.68148199 C16.2074256,7.32229028 16.6172921,7.03859985 17.088775,6.83900736 C17.5653276,6.63829358 18.0992069,6.53550719 18.6759837,6.53550719 M24.0588443,5.64332132 C23.4099216,5.02660298 22.6182671,4.54855283 21.7061096,4.22001015 C20.8017515,3.89146747 19.7835201,3.72700925 18.6759837,3.72700925 C17.6066652,3.72700925 16.6087126,3.89146747 15.714494,4.22001015 C14.8128658,4.54855283 14.026671,5.02660298 13.3793082,5.64332132 C12.7303855,6.26041343 12.2132752,7.01280981 11.8451364,7.88032694 C11.4773875,8.74896537 11.2921482,9.72076397 11.2921482,10.7740441 C11.2921482,11.8422751 11.4629584,12.8136999 11.7971692,13.6681351 C12.1360597,14.5322883 12.6391308,15.2835634 13.2907833,15.904767 C13.939316,16.5184951 14.7251208,16.9984141 15.6294789,17.3277044 C16.5205776,17.6551257 17.5466087,17.819584 18.6759837,17.819584 C19.7261934,17.819584 20.7163465,17.6551257 21.6199245,17.3280781 C22.533252,16.9984141 23.3229566,16.5184951 23.9710994,15.904767 C24.6184622,15.2891699 25.1347925,14.5416325 25.5037113,13.6804695 C25.8722401,12.8226703 26.0598193,11.8452652 26.0598193,10.7740441 C26.0598193,9.72823934 25.8897891,8.75681452 25.5540184,7.8926613 C25.2143479,7.01804257 24.7116668,6.26265604 24.0588443,5.64332132" id="Fill-3"/>
                      <path d="M36.8815412,6.53550719 C38.0460143,6.53550719 38.9593418,6.89694151 39.6737807,7.63476091 C40.3850998,8.36996392 40.7454391,9.42511294 40.7454391,10.7740441 C40.7454391,11.4266443 40.6471648,12.0224316 40.4529559,12.5423438 C40.261087,13.0577708 39.9908325,13.5021818 39.6531119,13.8666063 C39.3189011,14.2272931 38.9137144,14.5094884 38.4496411,14.710576 C37.5175947,15.1105085 36.2447078,15.1090134 35.2951124,14.7090809 C34.8236295,14.5094884 34.4137631,14.2272931 34.0791623,13.8666063 C33.7441716,13.505172 33.4821066,13.0618823 33.2984272,12.5486979 C33.1127979,12.0269168 33.0184233,11.430382 33.0184233,10.7740441 C33.0184233,10.1345259 33.1127979,9.53911239 33.2984272,9.00873461 C33.4821066,8.48919613 33.7441716,8.03992617 34.0779924,7.68148199 C34.4137631,7.32229028 34.8236295,7.03859985 35.2951124,6.83900736 C35.772445,6.63829358 36.3047644,6.53550719 36.8815412,6.53550719 M42.2659617,5.64332132 C41.6146992,5.02660298 40.8230447,4.54855283 39.912057,4.22001015 C39.008089,3.89146747 37.9890776,3.72700925 36.8815412,3.72700925 C35.8106628,3.72700925 34.81505,3.89146747 33.9200515,4.22001015 C33.0192033,4.54855283 32.2330084,5.02660298 31.5840858,5.64332132 C30.935943,6.25891836 30.4203926,7.01056719 30.0514738,7.88032694 C29.6821651,8.74896537 29.4969257,9.72076397 29.4969257,10.7740441 C29.4969257,11.8392849 29.6677359,12.8122048 30.0035066,13.6681351 C30.3423971,14.5322883 30.8446883,15.2835634 31.4971207,15.904767 C32.1448735,16.5184951 32.9314583,16.9984141 33.8342564,17.3277044 C34.728475,17.6551257 35.7525561,17.819584 36.8815412,17.819584 C37.9333108,17.819584 38.9234639,17.6551257 39.8247021,17.3280781 C40.7380296,16.9984141 41.5292941,16.5184951 42.1782168,15.9032719 C42.8247996,15.2880486 43.3411299,14.5416325 43.7100487,13.6804695 C44.0785775,12.8211753 44.2661568,11.8437701 44.2661568,10.7740441 C44.2661568,9.72823934 44.0945666,8.75681452 43.7587959,7.8926613 C43.4206854,7.01804257 42.9156644,6.26265604 42.2659617,5.64332132" id="Fill-5"/>
                      <path d="M56.3742977,6.74354684 C56.6098442,6.74354684 56.8009332,6.55591496 56.8009332,6.32156199 L56.8009332,4.45869883 C56.8009332,4.22733601 56.6098442,4.03820906 56.3742977,4.03820906 L53.0899065,4.03820906 L53.0899065,0.629064829 C53.0899065,0.395459397 52.8995975,0.207079977 52.6632711,0.207079977 L50.1108678,0.207079977 C49.8757113,0.207079977 49.6846223,0.395459397 49.6846223,0.629064829 L49.6846223,4.03820906 L47.445371,4.03820906 C47.2098245,4.03820906 47.0179556,4.22733601 47.0179556,4.45869883 L47.0179556,6.32156199 C47.0179556,6.55591496 47.2098245,6.74354684 47.445371,6.74354684 L49.6846223,6.74354684 L49.6846223,13.4650292 C49.6846223,14.8300325 50.0866892,15.860139 50.8779537,16.5280636 C51.6497193,17.1799162 52.7974234,17.5092064 54.2879177,17.5092064 L56.3742977,17.5092064 C56.6098442,17.5092064 56.8009332,17.3200795 56.8009332,17.0872216 L56.8009332,15.1208245 C56.8009332,14.8879666 56.6098442,14.6995872 56.3742977,14.6995872 L54.6338278,14.6995872 C54.0601708,14.6995872 53.6405549,14.5923156 53.4182677,14.3871166 C53.1994902,14.1856552 53.0899065,13.8051587 53.0899065,13.2575876 L53.0899065,6.74354684 L56.3742977,6.74354684 Z" id="Fill-7"/>
                  </g>
                  <g id="Logo_Icon">
                      <path d="M15.4953555,22.1491049 L15.4953555,15.6287716 L17.4678252,15.6287716 C17.9121933,16.2785559 18.6606193,16.6730461 19.4731068,16.6730461 C20.8015239,16.6730461 21.8824448,15.6217814 21.8824448,14.328899 C21.8824448,13.0360167 20.8015239,11.9841441 19.4731068,11.9841441 C18.6606193,11.9841441 17.9121933,12.3789382 17.4678252,13.0284186 L13.2107031,13.0284186 C12.9953939,13.0284186 12.8200841,13.1986147 12.8200841,13.4083206 L12.8200841,23.0684676 C12.8200841,23.1693696 12.861646,23.2663206 12.9350824,23.3374382 L20.7949615,30.677448 C20.8680854,30.7485657 20.9677713,30.7883794 21.0708947,30.7883794 L23.7483536,30.7883794 C23.9064761,30.7883794 24.0486615,30.6956833 24.108973,30.553752 C24.1695971,30.4118206 24.1358476,30.2486147 24.0242868,30.1401147 L15.4953555,22.1491049 Z" id="Fill-10"/>
                      <path d="M34.1791619,30.3650775 L34.176037,0.683793137 C34.176037,0.474391176 34.0010397,0.303891176 33.785418,0.303891176 L0.390618994,0.303891176 C0.175309804,0.303891176 0,0.474391176 0,0.683793137 L0,30.4267735 C0,30.6370873 0.175309804,30.8066755 0.390618994,30.8066755 L0.890611305,30.8066755 C0.930298195,30.8066755 0.969360094,30.8002931 1.00529704,30.7884402 L2.28402738,30.7884402 C2.49933657,30.7884402 2.67464637,30.618548 2.67464637,30.4085382 L2.67464637,2.90515588 L31.5010781,2.90515588 L31.5010781,28.5096363 L24.4221245,22.2749892 L27.3498919,22.2749892 C27.5661386,22.2749892 27.7405109,22.1050971 27.7405109,21.8950873 L27.7405109,6.79626373 C27.7405109,6.58655784 27.5661386,6.41636176 27.3498919,6.41636176 L6.77708329,6.41636176 C6.56114911,6.41636176 6.3864643,6.58655784 6.3864643,6.79626373 L6.3864643,30.4085382 C6.3864643,30.618548 6.56114911,30.7884402 6.77708329,30.7884402 L8.67049168,30.7884402 C8.88642586,30.7884402 9.06111067,30.618548 9.06111067,30.4085382 L9.06111067,9.01793039 L25.0668021,9.01793039 L25.0668021,19.6737245 L20.1725023,19.6737245 C19.9562556,19.6737245 19.7818833,19.8442245 19.7818833,20.0536265 L19.7818833,21.4261363 C19.7818833,21.5306853 19.8256326,21.6309794 19.9037564,21.7020971 L29.6807936,30.684499 C29.753605,30.7513618 29.849541,30.7884402 29.9489145,30.7884402 L33.7910429,30.7884402 C33.9019787,30.7884402 34.0082271,30.7419402 34.0826009,30.661401 C34.1566623,30.5805578 34.1913493,30.4726657 34.1791619,30.3650775" id="Fill-12"/>
                  </g>
              </g>
          </g>
      </g>
  </svg>
</a>

> Note:
>
> This project is still in the early phases. Any and all feedback,
> comments and suggestions are welcome. Please open an issue if you
> find anything unclear or misleading in the documentation. 
> 
> PRs and ideas for performance improvements, enabling clustering/scaleout and persistence
> will also be hugely appreciated.
>
> The api surface is still in a state of flux. While this note is in place, it probably isn't 
> advisable to build on NAct. The API should stabilise quite shortly, but it has been challenging 
> creating an API which is both flexible and familiar to javascript users.   

## Introduction

In the late 80s, Erisson needed a language in which to program the next generation of telephone exchanges. The language needed to be distributed by design, highly available, and fault tolerant. A team consisting initially of Joe Armstrong, Mike Williams and Robert Virding came up with an elegant solution: [Erlang](erlang.org). 

Erlang was inpsired by a mathematical formalism of distributed systems called the [actor model](http://www.brianstorti.com/the-actor-model/). The actor model describes distributed systems as a set of indepently running processes called actors. Actors communicate through message passing and can create, destroy and supervise the lifecycle of child actors. Whenever an actor is sent a message, it is added to its mailbox queue. An actor can retrieve a single message from the front of its mailbox at a time, and in response, perform some side effect, or send messages to other actors. If an actor behaves badly, the integrity of the system is preserved as actors are partitioned from one another.

A concrete example one could use is Whatsapp (which was known at some point to have been using Erlang on its servers). While their codebase is closed, a naive implemenation of their group chat feature could be as follows:

A connection between a single user's mobile app and the servers is represented as an actor. This actor can receive two types of messages: A `send` message from the user which contains the message contents and a group or user id to which the message is addressed. The other message is a `receive` message, which contains the sender and group id and message contents. The `receive` message is forwarded to the mobile client, while the `send` message is passed to an actor representing the user or group to which the message is addressed. The actor stores the references to all actors involved in the group conversation and whenever it receives a `send` message, it maps it to a message of type `receive` and sends it to all group member actors. 

The relative simplicity (even though it of course misses out some important production details) of this system is exactly the sort of use case Erlang was created for. The trouble is that Erlang, while excellent for some use cases, isn't in my opinion a general purpose enough language, which has had an impact on its ecosystem and libaries. 

NAct is an implementation of the Actor Model for Node.js. It is inspired by the approaches taken by [Akka](getakka.net) (available on the JVM and the CLR) and Erlang. The initial release is focused on providing a good experience on a single node, though later releases will focus on enabling clustering and scaleout. 

## Getting Started

> Note:
> 
> Each example is hosted on glitch. 
> To see source code, click on buttons like the one below.
> This particular button demonstrates the greeter example below

[![Remix on Glitch](https://cdn.glitch.com/2703baf2-b643-4da7-ab91-7ee2a2d00b5b%2Fremix-button.svg)](https://glitch.com/edit/#!/remix/https://nact-gettingstarted-greeter.glitch.me)

NAct has only been tested to work on Node 8 and above. You can install NAct in your project by invoking the following:

```bash
    npm install --save nact
```

Once installed, you need to import the start function, which starts and 
then returns the actor sytem.

```js
const { start } = require('nact');
const system = start();
```

Once you have a reference to the system, it is now possible to create our
first actor. To create an actor you have to `spawn` it.  As is traditional,
let us create an actor which says hello when a message is sent to it. Since 
this actor doesn't require any state, we can use the simpler `spawnFixed` function. 

```js
const greeterActor = spawnFixed(system, (msg) => console.log(`Hello ${msg.name}`), 'greeter');
```
The first argument to `spawnFixed` is the parent, which is in this case the actor system. The hierarchy section will go into more detail about this.

The second argument to `spawnFixed` is a function which is invoked when a message is received. It is important to note that this function cannot reference anything outside the scope of the function. This is because the actor is running in a separate thread and thus can't share memory with the main process. 

The third argument to `spawnFixed` is the name of the actor,
which in this case is `'greeter'`. The name field is optional, and 
if ommitted, the actor is automatically assigned a name by the system.

To communicate with the greeter, we need to `tell` it who we are:

```js
greeterActor.tell({ name: 'Erlich Bachman' });
```

This should print `Hello Erlich Bachman` to the console. 

To complete this example, we need to shutdown our system. We can do this
by calling `system.stop();`

## State

[![Remix on Glitch](https://cdn.glitch.com/2703baf2-b643-4da7-ab91-7ee2a2d00b5b%2Fremix-button.svg)](https://glitch.com/edit/#!/remix/https://nact-gettingstarted-counter.glitch.me)

Most actors aren't very useful without state. But  `spawnFixed` makes it near impossible to create stateful actors. The solution is to use the `spawn` function instead. `spawn` has nearly the same function signature as `spawnFixed` however the fundamental difference is that `spawn` takes 
in a function which has no arguments and returns another function.

The returned function is used to handle next message and should itself return a function which is used for the message after that (and so on). When no function is returned, the actor is stopped as no further processing may occur.

This may sound quite confusing, but could be likened to an asynchronous `reduce`.  A simple example to demonstrate the use of `spawn` is a counter actor. The counter should be able to hold the current count and up receipt of a message add the value to the count and then log it.

We want to be able to do the following:

```js
counterActor.tell(1); // logs 1
counterActor.tell(-1); // logs 0
counterActor.tell(1); // logs 1
```
Assuming we've already created our system, we could implement the counter as follows:

```js
let counterActor = spawn(
  system,
  () => {
    const counter = (count) => (msg) => {
       const nextCount = count+msg;
       console.log(nextCount);
       return counter(nextCount);
    };
    return counter(0);
  },
  'counter'
);
```
Here we pass in a function and then inside the scope of this function,
define a [higher order function](https://en.wikipedia.org/wiki/Higher-order_function) which takes in the current count and then returns a function which is able to handle the actual message. This function when invoked, prints out hte latest count and then returns itself with an updated count.

Again you can play around with this concept if you click the glitch button at the top of this section.

## Communication between actors

[![Remix on Glitch](https://cdn.glitch.com/2703baf2-b643-4da7-ab91-7ee2a2d00b5b%2Fremix-button.svg)](https://glitch.com/edit/#!/remix/https://nact-gettingstarted-multi.glitch.me)

We've been looking at examples with single actors, but actors are a part of a _system_. And systems are very sad things if they are made up of just one element. Let us use another traditional test activity PingPong, to demonstrate how actors can communcation with one another. 

In the example below, the ping and pong actors log the message they've received and then tell the sender their name. To start off this perfect
match, we tell the pingActor the pong actor's name and use `tell's` second parameter to specify the sender as being the pongActor (all actors have a name and path property).

> Note:
>
> In `pingActor`, we use an arrow function. Thus to issue commands from inside the actor, we need to accept a second argument: the actor context.
>
> In the `pongActor`, we are using function form, and while it too can accept the context as a second argument, `this` is also set to the context.


```js
let pingActor = spawnFixed(system, (msg, ctx)=>{ console.log(msg); ctx.tell(ctx.sender, ctx.name); }, 'ping'); 

let pongActor = spawnFixed(system, function(msg){ console.log(msg); this.tell(this.sender, this.name); }, 'pong'); 

pingActor.tell(pongActor.name(), pongActor);
```

In the sample, the system is terminated after 5 seconds to give glitch a break.


## Asking instead of telling

[![Remix on Glitch](https://cdn.glitch.com/2703baf2-b643-4da7-ab91-7ee2a2d00b5b%2Fremix-button.svg)](https://glitch.com/edit/#!/remix/https://nact-gettingstarted-ask.glitch.me)

We've only been passing messages to actors inside the system, but what if we want to pass messages _out_? 

`ask()` is the primary means of interacting with actors from outside the actor system (actors have no such problem as they can simply `tell` one another) 

Ask behaves very similarly to tell, except that it has a second parameter (a timeout in milliseconds. Ask creates a virtual actor for the request and when this virtual actor receives a message, the promise is resolved. 

> Note:
> It is best practise to specify a timeout in a production system to ensure 
> that promises do not remain unresolved indefitely.

Inside the real actor, we have access to a number of global variables and functions, two of which are `tell()` and `sender`. The `tell()` inside the actor behaves very similarly to `actor.tell()` outside it, with the important difference that the first argument to the `tell()` function inside the actor is the recipient. `sender` is just that, the entity that dispatched the message. Putting the two toghether we can resolve the ask with a `tell(sender, <MESSAGE_HERE>)`

The glitch example in this section builds upon the counter example, but instead of simply printing the result, returns the updated count to the sender.


## Actor Hierachy and Lifecycle 

One of the more important features of an actor system is its hierachy. Actors can have child actors. The lifecycle of a child actor is tied to that of its parent. If a parent actor is shutdown or terminates, all children in the tree are shut down. This hierachy, combined with [supervision](./#supervision), allows for robust error handling and recovery. 

You can spawn children for a given actor outside the actor function by invoking spawn/spawnFixed on the actor object. Inside the actor function, the context object allowing spawning as follows:

```js
let actor = spawnFixed (
  system, 
  function(msg){ spawn(this.self, ()=>function f(msg){ console.log('I\m a child actor'); return f; }, 'child'); }
);
```

To stop an actor, you can call stop on the actor object e.g. `actor.stop()`. If you want to immediately terminate the actor, you can call `actor.terminate()`. These two methods are quite ungraceful, and often a better alternative is to shutdown the actor from the inside. If you spawned the actor using spawnFixed, you can stop the actor function after receiving a message, by returning `false`. If you instead created the actor using the spawn command, stopping the actor is as simple as not returning the next handler function.

Using spawn:
```js
let actor = spawn(
  system, 
  // No next function is returned, hence the actor shuts down.
  () => function(msg,ctx){ console.log('I\'m shutting down now'); }
);
```

Using spawnFixed:
```js
let actor = spawnFixed(
  system,
  function(msg){ console.log('I\m shutting down now'); return false; }
);
```

An actor by default is also terminated when it throws an exception, unless an action is taken by a supervisor.

To check whether an actor is stopped, you can call `isStopped()` on the actor object. You can obtain a Map of an actor's children by calling children() on the actor object or `ctx.children` from inside the actor function.
Likewise, to get the parent of an actor you can call `parent()` on the actor object or `parent` on the context object.

Children can be stopped from inside the actor by calling `child.stop()`

## Supervision 

NAct empowers parent actors to monitor their children. This is strictly on an opt in basis.
If a child crashes and a parent has opted into receiving death messages, the message handler 
of the parent actor will be called with the following payload.

```js
return { type: 'CHILD_FAILED', child, exception, failure_context }
```

This message gives the actor an opportunity to recover from the failure. They could for example call `child.restart()`
